<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="../css/styleLogin.css">
</head>

<body class="body">
  <div class="container">
    <form id="form-signin" class="form-container">
      <p id="heading">Sign In</p>
      <div class="form-group">
        <input id="username" autocomplete="on" placeholder="Username" class="form-control input-field" type="text"
          required>
      </div>
      <div class="form-group">
        <input id="password" placeholder="Password" class="form-control input-field" type="password" required>
      </div>
      <div class="form-group check">
        <label class="form-check-label" for="isAdmin">Account Admin?</label>
        <input type="checkbox" class="form-check-input" id="isAdmin">
      </div>
      <div class="form-group" id="adminPasswordGroup" style="display: none;">
        <input id="adminPassword" placeholder="Admin Password" class="form-control input-field" type="password">
      </div>
      <div class="btn-group">
        <button type="submit" class="btn" id="submit">Sign Up</button>
      </div>
      <p id="error-message" class="text-danger" style="display: none;">Password admin errata!</p>
    </form>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () 
    {
        const isAdminCheckbox = document.getElementById("isAdmin");
        const adminPasswordGroup = document.getElementById("adminPasswordGroup");
        const form = document.getElementById("form-signin");
        const errorMessage = document.getElementById("error-message");

        isAdminCheckbox.addEventListener("change", function () {
            adminPasswordGroup.style.display = this.checked ? "block" : "none";
        });

        form.addEventListener("submit", async function (event) 
        {
            event.preventDefault();

            try {
                const response = await fetch('/api/utenti');
                if (!response.ok) {
                    throw new Error('Errore nel recupero degli utenti');
                }

                const utenti = await response.json();
                const username = document.getElementById("username").value;
                const password = document.getElementById("password").value;
                const permission = document.getElementById("isAdmin").checked;
                let isValid = false;
                let isAdmin = false;
                let id =0;


                for (let i = 0; i < utenti.length; i++)
                {
                    if (username != utenti[i].username && password != utenti[i].password) {
                        isValid = true;
                        if (utenti[i].isAdmin==permission) 
                        {
                            if (isAdminCheckbox.checked) 
                            {
                                const adminPassword = document.getElementById("adminPassword").value;
                                if (adminPassword !== "lisso") {
                                    errorMessage.style.display = "block";
                                    return;
                                }
                                else
                                {
                                    isValid = true;
                                    isAdmin = true;
                                }
                            }
                            else
                            {
                                isValid = true;
                            }
                        }
                        break;
                    }
                }

                if (isValid) 
                {
                    if (isAdmin==true) {
                        fetch('/api/utenti', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ username: username, password: password, isAdmin: isAdmin })
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Admin creato');
                                document.getElementById('form-signin').reset();
                            })
                            .catch(error => {
                                console.error('Errore:', error);
                                console.log('Si è verificato un errore');
                        });
                        localStorage.setItem("idUtente", `${id}`);
                        window.location.href = "HomePage.html?isAdmin=true";
                    }
                    else
                    {
                        fetch('/api/utenti', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ username: username, password: password, isAdmin: isAdmin })
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('profilo creato');
                                document.getElementById('form-signin').reset();
                            })
                            .catch(error => {
                                console.error('Errore:', error);
                                console.log('Si è verificato un errore');
                        });
                        localStorage.setItem("idUtente", `${id}`);
                        window.location.href = "HomePage.html";
                    }
                } else {
                    console.log("Credenziali non valide");
                    alert("Username o password già presenti!");
                }
                } catch (error) {
                    console.error("Errore durante la richiesta:", error);
                }
        });
    });
  </script>

</body>

</html>
