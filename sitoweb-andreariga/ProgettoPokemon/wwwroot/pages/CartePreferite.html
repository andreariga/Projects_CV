<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Pokémon Salvate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/styleCartePreferite.css">
    <link rel="stylesheet" href="../css/styleHeader.css">
    <link rel="stylesheet" href="../css/styleFooter.css">
</head>
<body>
    <div id="header-container"></div>
    <h1 class="text-center mt-4">Carte Pokémon Salvate</h1>
    <div class="container mt-5">
        <div id="cards-container" class="row"></div>
    </div>
    <div id="footer-container"></div>
    <script>
      async function fetchCards() {
        try {
            const response = await fetch('/api/get-card');
            if (!response.ok) {
                throw new Error('Errore nel recupero delle carte');
            }
            const cards = await response.json();
            displayCards(cards);
        } catch (error) {
            console.error("Errore:", error);
            alert("Impossibile caricare le carte.");
        }
    }

    async function deleteCard(idCarta) {
        if (!confirm("Sei sicuro di voler eliminare questa carta?")) {
            return;
        }
        try {
            console.log(idCarta)
            const response = await fetch(`/api/delete-card/${idCarta}`, { method: "DELETE" });
            if (!response.ok) {
                throw new Error("Errore durante l'eliminazione della carta");
            }
            fetchCards();
        } catch (error) {
            console.error("Errore:", error);
            alert("Impossibile eliminare la carta.");
        }
    }

    function displayCards(cards) {
    console.log(cards);
    const container = document.getElementById("cards-container");
    container.innerHTML = '';

    if (cards.length === 0) {
        container.innerHTML = '<p class="text-center">Nessuna carta salvata.</p>';
        return;
    }

    cards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.classList.add('col-12', 'mb-4'); 

        const imageUrl = card.images?.large || card.images?.small || 'https://via.placeholder.com/350x500';
        const marketPrice = card.tcgplayer?.prices?.market ? `${card.tcgplayer.prices.market} $` : "N/A";

        let attacksHTML = "";
        if (card.attacks && card.attacks.length > 0) {
            attacksHTML = `<p><strong>Mosse:</strong></p><ul>`;
            card.attacks.forEach(attack => {
                const energyCost = attack.cost ? attack.cost.join(', ') : 'N/A'; 
                attacksHTML += `
                    <li>
                        <strong>${attack.name}</strong> 
                        <br> Danno: ${attack.damage} 
                        <br> Costo Energia: ${energyCost} 
                        <br> Energia Convertita: ${attack.convertedEnergyCost}
                        <br> Effetto: ${attack.text}
                    </li>
                `;
            });
            attacksHTML += `</ul>`;
        } else {
            attacksHTML = "<p><strong>Mosse:</strong> Nessuna mossa disponibile.</p>";
        }

        let weaknessesHTML = "";
        if (card.weaknesses && card.weaknesses.length > 0) {
            weaknessesHTML = `<p><strong>Debolezze:</strong></p><ul>`;
            card.weaknesses.forEach(weakness => {
                weaknessesHTML += `<li><strong>${weakness.type}:</strong> ${weakness.value}</li>`;
            });
            weaknessesHTML += `</ul>`;
        } else {
            weaknessesHTML = "<p><strong>Debolezze:</strong> Nessuna debolezza disponibile.</p>";
        }

        cardElement.innerHTML = `
            <div class="card p-3">
                <div class="row g-0">
                    <div class="col-md-4">
                        <img src="${imageUrl}" class="img-fluid rounded-start" alt="${card.name}">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h3 class="card-title">${card.name}</h3>
                            <p class="card-text"><strong>HP:</strong> ${card.hp || 'N/A'}</p>
                            <p class="card-text"><strong>Tipo:</strong> ${card.supertype || 'N/A'}</p>
                            <p class="card-text"><strong>Rarità:</strong> ${card.rarity || 'N/A'}</p>
                            <p class="card-text"><strong>Set:</strong> ${card.set?.name || 'N/A'} (<i>${card.set?.series || 'N/A'}</i>)</p>
                            <p class="card-text"><strong>Numero:</strong> ${card.number || 'N/A'}</p>
                            <p class="card-text"><strong>Artista:</strong> ${card.artist || 'N/A'}</p>
                            <p class="card-text"><strong>Legalità:</strong> ${card.legalities?.unlimited || 'N/A'}</p>
                            <p class="card-text"><strong>Ritirata:</strong> ${card.convertedRetreatCost || 'N/A'}</p>
                            ${attacksHTML}
                            ${weaknessesHTML}
                            <p class="card-text"><strong>Prezzi TCGPlayer:</strong></p>
                            <ul>
                                <li><strong>Low:</strong> ${card.tcgplayer?.prices?.low || 'N/A'}$</li>
                                <li><strong>Mid:</strong> ${card.tcgplayer?.prices?.mid || 'N/A'}$</li>
                                <li><strong>High:</strong> ${card.tcgplayer?.prices?.high || 'N/A'}$</li>
                                <li><strong>Market:</strong> ${card.tcgplayer?.prices?.market || 'N/A'}$</li>
                            </ul>
                            <a href="${card.tcgplayer?.url || '#'}" target="_blank" class="btn btn-primary">Acquista su TCGPlayer</a>
                            <button class="btn btn-danger" onclick="deleteCard(${card.datasId})">Elimina</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        container.appendChild(cardElement);
    });
}




    document.addEventListener('DOMContentLoaded', fetchCards);
    function bottoneprofilo() {
        const contenitore = document.getElementById("navbar");
        let bottone = document.createElement("a");
        bottone.classList.add("profile-button"); 
        bottone.href = `Profilo.html`
        bottone.innerText = `profilo`;
        contenitore.appendChild(bottone);
        }
        function compareMenu() {
            const navLinks = document.querySelector(".nav-links2");

            if (navLinks.style.display === "none" || navLinks.style.display === "") {
                navLinks.style.display = "flex";
                navLinks.style.opacity = "1";
                navLinks.style.visibility = "visible";
                navLinks.style.transform = "translateY(0)";
            } else {
                navLinks.style.opacity = "0";
                navLinks.style.visibility = "hidden";
                navLinks.style.transform = "translateY(-10px)";
                navLinks.style.display = "none";
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            
            await TemplateLoader.initializeTemplates();
            await bottoneprofilo();
        });
    </script>

    <script src="../js/template-loader.js"></script>

</body>
</html>