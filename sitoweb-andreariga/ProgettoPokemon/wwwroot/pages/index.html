<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="../css/styleLogin.css">
</head>

<body class="body">
  <div class="container">
    <form id="form-login" class="form-container" action="HomePage.html" method="get">
      <p id="heading">Login</p>
      <div class="form-group">
        <input id="username" autocomplete="on" placeholder="Username" class="form-control input-field" type="text"
          required>
      </div>
      <div class="form-group">
        <input id="password" placeholder="Password" class="form-control input-field" type="password" required>
      </div>
      <div class="form-group check">
        <label class="form-check-label" for="isAdmin">Account Admin?</label>
        <input type="checkbox" class="form-check-input" id="isAdmin">
      </div>
      <div class="btn-group">
        <button type="submit" class="btn" id="submit">Login</button>

        <a href="SignIn.html" class="btn">Sign up</a>
      </div>
    </form>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("form-login");

      form.addEventListener("submit", async function (event) {
        event.preventDefault();

        try {
          const response = await fetch('/api/utenti');
          if (!response.ok) {
            throw new Error('Errore nel recupero degli utenti');
          }

          const utenti = await response.json();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;
          const permission = document.getElementById("isAdmin").checked;
          let isValid = false;
          let isAdmin = false;
          let id =0;


          for (let i = 0; i < utenti.length; i++) {
            if (username === utenti[i].username && password === utenti[i].password) {
              isValid = true;
              id = utenti[i].id;
              if (utenti[i].isAdmin==permission) {
                isAdmin = true;
                id = utenti[i].id;
              }
              break;
            }
          }
          

          if (isValid) {
            if (document.getElementById("isAdmin").checked && isAdmin==true) {
              console.log("Benvenuto Admin");
              localStorage.setItem("idUtente", `${id}`);
              window.location.href = "HomePage.html?isAdmin=true";
            }
            else
            {
              console.log("Benvenuto");
              localStorage.setItem("idUtente", `${id}`);
              window.location.href = "HomePage.html";
            }
          } else {
            console.log("Credenziali non valide");
            alert("Username o password errati!");
          }
        } catch (error) {
          console.error("Errore durante la richiesta:", error);
        }
      });
    });
  </script>

</body>

</html>